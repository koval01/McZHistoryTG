$(document).ready(function () {
    function clear_str_(string_) {
        return string_.toString().replace(/\\n/g, '').replace(/\\"/g, '"').replace(/\\/g, '')
    }
    function get_channel_html_data(callback, bef_ = null) {
        $.ajax({
            url: `https://zlpnews.herokuapp.com/?before=${bef_}`,
            type: "GET",
            success: function (o) {
                if (o["success"]) {
                    callback(clear_str_(o["body"]))
                } else {
                    console.log("Check error! (get_channel_html_data)")
                }
            },
            error: function () {
                console.log("Error get channel data!")
            }
        })
    }
    function* struct_els(els) {
        for (let i = 0; i < els.length; i++) {
            // console.log(els[i])
            const el = $('<div></div>')
            el.html(els[i])
            const text_post = $(".tgme_widget_message_text").html()
            var finish_data = {"post_text": text_post, "m_type": null}
            yield finish_data
        }
    }
    function add_post(post_data) {
        const post_text = post_data["post_text"]
        const m_type = post_data["m_type"]
        var media_pattern = null
        image_pattern = `
            <img src="${m_url}" class="bd-placeholder-img card-img-top" 
                width="100%" height="225" role="img" title="Фото Залупы" aria-label="Фото Залупы">`
        video_pattern = `
            <video src="${m_url}" class="bd-placeholder-img card-img-top" 
                width="100%" height="225" role="img" title="Видео Залупы" aria-label="Видео Залупы"></video>`
        if (m_type == "image") {
            media_pattern = image_pattern
        } else if (m_type = "video") {
            media_pattern = video_pattern
        }
        pattern = `
            <div class="col">
                <div class="card shadow-sm">
                    ${media_pattern}
                    <div class="card-body"><p class="card-text">${post_text}</p></div>
                </div>
            </div>
        `
        $(".row").append(pattern)
    }
    function loads_posts(before = null) {
        get_channel_html_data(function (data) { 
            const el = $('<div></div>')
            el.html(data)
            const parsed_els = $('.tgme_widget_message_wrap', el)
            const struct = struct_els(parsed_els)
            add_post(struct.next().value)
        }, bef_ = before)
    }

    // init
    loads_posts()
})
